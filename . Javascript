/****  BSS ‚Äî SMS Admin sou Form Submit (Twilio)  ****/

const TWILIO_SID   = 'ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'; // Twilio Account SID
const TWILIO_TOKEN = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'; // Twilio Auth Token
const TWILIO_FROM  = '+1XXXXXXXXXX';                     // Twilio number (E.164)
const ADMINS = [
  '+509XXXXXXXX',   // Admin #1 (E.164)
  '+1XXXXXXXXXX'    // Admin #2 (opsyon√®l)
];

/** Voye SMS atrav√® Twilio */
function sendSMS(to, message) {
  const url = 'https://api.twilio.com/2010-04-01/Accounts/' + TWILIO_SID + '/Messages.json';
  const payload = { To: to, From: TWILIO_FROM, Body: message };
  const options = {
    method: 'post',
    payload,
    headers: { Authorization: 'Basic ' + Utilities.base64Encode(TWILIO_SID + ':' + TWILIO_TOKEN) },
    muteHttpExceptions: true
  };
  const res = UrlFetchApp.fetch(url, options);
  // Logger.log(res.getResponseCode() + ' ' + res.getContentText()); // (si w vle w√® repons)
}

/** KONPIL mesaj otomatikman ak tout chan ki vini nan f√≤m nan */
function buildMessage_(e) {
  // e.namedValues gen { "Header": ["val√®"] }
  const lines = [];
  lines.push('üîî Nouvo tranzaksyon BSS');
  lines.push('‚è± ' + Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm'));
  lines.push('‚Äî ‚Äî ‚Äî');
  Object.keys(e.namedValues).forEach(function (key) {
    // Sote chan vid yo
    const raw = (e.namedValues[key] || []).join(', ').trim();
    if (raw) lines.push(key + ': ' + raw);
  });
  lines.push('‚Äî ‚Äî ‚Äî');
  lines.push('BSS Bot');
  // Limite long√® (Twilio ka segmante, men n ap koupe si tw√≤ long)
  return lines.join('\n').slice(0, 1200);
}

/** Trigger: ap rele otomatikman l√® f√≤m nan soum√®t (via Sheet) */
function onFormSubmit(e) {
  try {
    const msg = buildMessage_(e);
    ADMINS.forEach(function (to) { sendSMS(to, msg); });
  } catch (err) {
    Logger.log('SMS error: ' + err);
  }
}

/** T√®s many√®l (ranvwaye yon SMS vid pou verifye kle yo) */
function testSMS() {
  sendSMS(ADMINS[0], 'T√®s BSS: konfig Twilio mache ‚úÖ');
}
